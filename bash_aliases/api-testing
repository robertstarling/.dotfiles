# Lookup the Azure resource ID of the first cluster containing the specific substring
# Return an error if no matching cluster is found
get_cluster_id() {
  az resource list --resource-type "Microsoft.NetworkCloud/clusters" --query "[?contains(name, '$1')].id" -o tsv
}

# with error handling
get_cluster_id_or_fail() {
  local substring="$1"
  local cluster_id
  cluster_id=$(az resource list --resource-type "Microsoft.NetworkCloud/clusters" --query "[?contains(name, '$substring')].id" -o tsv | head -n 1)
  if [ -z "$cluster_id" ]; then
    echo "No cluster found containing substring: $substring" >&2
    return 1
  fi
  echo "$cluster_id"
}

# sim_health runs the cluster-health suite against the first matching cluster.
# Accepts either a descriptive substring or a numeric build id (simdev-<id>).
# Environment variables are set only for the child process and won't leak
# into the caller's shell after the function returns.
sim_health() {
  local substring="$1"
  if [ -z "$substring" ]; then
    echo "Usage: sim_health <cluster-name-substring|build-id>" >&2
    return 2
  fi

  if [[ "$substring" =~ ^[0-9]+$ ]]; then
    substring="simdev-$substring"
  fi

  source ~/e2e/sim || return 1

  # Resolve cluster id (first match) and fail if not found.
  local ClusterID
  ClusterID=$(get_cluster_id_or_fail "$substring") || return 1

  # Ephemeral values (30-char date pattern kept as original intent).
  local ResourceGroup="robstarling-tmp-api-testing-$(date +%y%m-%d)"
  local RunInParallel=true
  local SkipCleanupSuite=True
  local Suites="cluster-health"
  local Processors=4
  local LabelFilter='!AzureLocalRackScale'

  ( cd ~/nc-api-testing/ || exit 1
    # Inline env assignment ensures variables apply only to this command.
    ClusterID="$ClusterID" \
    ResourceGroup="$ResourceGroup" \
    RunInParallel="$RunInParallel" \
    SkipCleanupSuite="$SkipCleanupSuite" \
    Suites="$Suites" \
    Processors="$Processors" \
    LabelFilter="$LabelFilter" \
      ./scripts/run-suites.sh --procs="$Processors" --label-filter "$LabelFilter"
  )
}
